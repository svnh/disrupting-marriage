<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Disrupting Marriage</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width" />
  <link rel="stylesheet" href="/public/bower_components/bootstrap/dist/css/bootstrap.css" />
  <link rel="stylesheet" href="/public/src/directives/btnUpload.min.css" />
  <!--[if lt IE 9]>
    <script src="/public/bower_components/es5-shim/es5-shim.min.js"></script>
    <script src="/public/bower_components/json3/lib/json3.min.js"></script>
    <script src="/public/bower_components/html5shiv/dist/html5shiv.js"></script>
    <script src="/public/bower_components/respond/respond.min.js"></script>
    <script src="/public/bower_components/n3-line-chart/dist/line-chart.min.js"></script>
  <![endif]-->
  <script src="/public/bower_components/angular/angular.js" charset="utf-8"></script>
  <script src="/public/angular-upload.js" charset="utf-8"></script>
  <script src="/public/bower_components/d3/d3.js"></script>
  <script src="/public/bower_components/n3-line-chart/dist/line-chart.js"></script>
  <script src="/public/bower_components/lodash/dist/lodash.min.js"></script>
  <script src="/public/bower_components/lodash/dist/lodash.underscore.min.js"></script>
  <script src="/public/example/fake_data_1.js"></script>
  <script src="/public/example/fake_data_2.js"></script>

  <script charset="utf-8">

    // Define our main app
    var app = angular.module('app', [
      'lr.upload',
      'n3-line-chart'
    ]);

    app.controller('AppCtrl', function ($scope, $http) {

      // App variable to show the uploaded response
      $scope.responseData = undefined;
      $scope.fakeData1 = fakeData1;
      $scope.fakeData2 = fakeData2;


      // Get initial uploads and populate list
      $http({
        method: 'get',
        url: '/uploads?' + new Date().getTime(),
        cache: false
      }).then(function (response) {
        $scope.uploads = response.data;
      });

      // Global handler for onSuccess that adds the uploaded files to the list
      $scope.onGlobalSuccess1 = function (response) {
        console.log(response.data);
        console.log('AppCtrl.onSuccess', response);
        $scope.fakeData1 = fakeData1;
        $scope.responseData = response.data;
        $scope.uploads = $scope.uploads.concat(response.data.files);
      };

      $scope.onGlobalSuccess2 = function (response) {
        console.log(response.data);
        $scope.fakeData2 = fakeData2;

        console.log('AppCtrl.onSuccess', response);
        $scope.responseData = response.data;
        $scope.uploads = $scope.uploads.concat(response.data.files);
      };

      var barFrameResuls = function(data) {
        return _.map(data, function(result) {
          return {
            'x': result.Timestamp,
            'Neutral': result.EmotionResult.Neutral,
            'Anger': result.EmotionResult.Anger,
            'Disgust': result.EmotionResult.Disgust,
            'Fear': result.EmotionResult.Fear,
            'Joy': result.EmotionResult.Joy,
            'Sadness': result.EmotionResult.Sadness,
            'Surprise': result.EmotionResult.Surprise
          }
        });
      };


      $scope.partner1Data = barFrameResuls($scope.fakeData1.VideoFrameResults);
      $scope.partner2Data = barFrameResuls($scope.fakeData2.VideoFrameResults);
      $scope.options = {
        axes: {
          x: {key: 'x', labelFunction: function(value) {return value;}, type: 'linear'},
          y: {type: 'linear', min: 0, max: 1},
          y2: {type: 'linear', min: 0, max: 1}
        },
        series: [
          {y: 'Neutral', color: 'black', thickness: '2px', type: 'area', striped: true, label: 'Neutral'},
          {y: 'Anger', color: 'steelblue', thickness: '2px', type: 'area', striped: true, label: 'Anger'},
          {y: 'Disgust', color: 'pink', thickness: '2px', type: 'area', striped: true, label: 'Disgust'},
          {y: 'Fear', color: 'green', thickness: '2px', type: 'area', striped: true, label: 'Fear'},
          {y: 'Joy', color: 'orange', thickness: '2px', type: 'area', striped: true, label: 'Joy'},
          {y: 'Sadness', color: 'purple', thickness: '2px', type: 'area', striped: true, label: 'Sadness'},
          {y: 'Surprise', color: 'red', thickness: '2px', type: 'area', striped: true, label: 'Surprise'}
        ],
        lineMode: 'linear',
        tension: 0.7,
        tooltip: {mode: 'scrubber', formatter: function(x, y, series) {return 'pouet';}},
        drawLegend: true,
        drawDots: true,
        columnsHGap: 0
      };

      $scope.process = function() {
        $http({
          method: 'post',
//          url: 'http://still--1197.herokuapp.com/process',
//          url: 'http://localhost:4567/process',
          url: 'http://still-headland-1197.herokuapp.com/process',
          crossDomain: true,
          data: {
            "emovuData": [$scope.fakeData1, $scope.fakeData2]
          }
        }).success(function(data, status, headers, config) {
          console.log(data);
        }).error(function(data, status, headers, config) {
          console.log(data);

        });

      }

    });

    app.controller('SimpleCtrl', function ($scope, $http) {
      // Nothing special needed from the controller
    });

    // Start it up
    angular.element(document).ready(function () {
      angular.bootstrap(document, ['app']);
    });

  </script>
</head>
<body>
  <div class="container" ng-controller="AppCtrl">
    <div class="jumbotron">
      <div class="jumbotron-body">
        <h1>Disruptiv Marriage</h1>
        <p>Evaluate your relationship. Should you start looking for your own appartment?? </p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="panel panel-default him" ng-controller="SimpleCtrl">
          <div class="panel-heading">
            <h3 class="panel-title">Partner A</h3>
          </div>
          <div class="panel-body">
            <upload-button
              class="btn btn-primary btn-upload"
              url="https://eyeris-emovu1.p.mashape.com/api/video/"
              on-success="onGlobalSuccess1(response)"
              headers='{X-Mashape-Key: "p2YEJ3Z7lBmshli8kbKm1iDDlE2Yp1Pi3Pxjsn1pG4zTFz8LEl"}'
            >Fileupload</upload-button>
          </div>
          <div class="panel-body">
            <upload-button
              class="btn btn-primary btn-upload"
              method="GET"
              url="/upload"
              on-success="onGlobalSuccess2(response)"
            >Fileupload FAKE</upload-button>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel panel-default her" ng-controller="SimpleCtrl">
          <div class="panel-heading">
            <h3 class="panel-title">Partner B</h3>
          </div>
          <div class="panel-body">
            <upload-button
              class="btn btn-primary btn-upload"
              url="https://eyeris-emovu1.p.mashape.com/api/video/"
              on-success="onGlobalSuccess(response)"
            >Fileupload</upload-button>
          </div>
          <div class="panel-body">
            <upload-button
              class="btn btn-primary btn-upload"
              method="GET"
              url="/upload"
              on-success="onGlobalSuccess(response)"
            >Fileupload FAKE</upload-button>
          </div>
        </div>
      </div>
      <button class="btn btn-primary btn-upload" ng-show="fakeData1 && fakeData2" ng-click='process()'>Process</button>
       <div style="display:inline; text-align:center;">
        <h3>Partner A</h3>
        <linechart data="partner1Data" options="options" mode=""></linechart>
        <h3>Partner B</h3>
        <linechart data="partner2Data" options="options" mode=""></linechart>
      </div>
    </div>

  </div>

</body>
</html>
